# Vritti Production Configuration
# ================================
#
# This file contains production-ready configuration for the Vritti Episodic Memory Service.
# Copy to .env and customize for your environment.
#
# SECURITY WARNING:
# - NEVER commit this file with real secrets
# - Use environment variables or secret management in production
# - Rotate API keys regularly
#

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================

# Server settings
SERVICE_HOST=0.0.0.0
SERVICE_PORT=8000
SERVICE_LOG_LEVEL=INFO
SERVICE_WORKERS=4

# Request limits (DoS protection)
SERVICE_MAX_REQUEST_BODY_SIZE=10485760  # 10MB
SERVICE_MAX_FILE_UPLOAD_SIZE=5242880    # 5MB
SERVICE_REQUEST_TIMEOUT_SECONDS=30

# ============================================================================
# KYRODB CONFIGURATION (Vector Database)
# ============================================================================

# Text embeddings instance (384-dim)
KYRODB_TEXT_HOST=kyrodb-text.internal
KYRODB_TEXT_PORT=50051

# Image embeddings instance (512-dim)
KYRODB_IMAGE_HOST=kyrodb-image.internal
KYRODB_IMAGE_PORT=50052

# Connection settings
KYRODB_MAX_WORKERS=10
KYRODB_CONNECTION_TIMEOUT_SECONDS=30
KYRODB_REQUEST_TIMEOUT_SECONDS=60

# TLS Configuration (REQUIRED for production)
KYRODB_ENABLE_TLS=true
KYRODB_TLS_VERIFY_SERVER=true
# KYRODB_TLS_CA_CERT_PATH=/etc/ssl/certs/ca-certificates.crt
# KYRODB_TLS_CLIENT_CERT_PATH=/etc/vritti/client.crt
# KYRODB_TLS_CLIENT_KEY_PATH=/etc/vritti/client.key

# ============================================================================
# EMBEDDING CONFIGURATION
# ============================================================================

EMBEDDING_TEXT_MODEL_NAME=all-MiniLM-L6-v2
EMBEDDING_TEXT_DIMENSION=384
EMBEDDING_TEXT_BATCH_SIZE=32

EMBEDDING_IMAGE_MODEL_NAME=openai/clip-vit-base-patch32
EMBEDDING_IMAGE_DIMENSION=512
EMBEDDING_IMAGE_BATCH_SIZE=16

EMBEDDING_DEVICE=cpu
EMBEDDING_ENABLE_GPU=false

# ============================================================================
# LLM CONFIGURATION (Reflection Generation)
# ============================================================================

# OpenRouter API (REQUIRED for reflections)
# Get API key from: https://openrouter.ai/keys
LLM_OPENROUTER_API_KEY=sk-or-v1-your-api-key-here
LLM_OPENROUTER_BASE_URL=https://openrouter.ai/api/v1

# Model selection (using free tier models by default)
LLM_CONSENSUS_MODEL_1=kwaipilot/kat-coder-pro:free
LLM_CONSENSUS_MODEL_2=tngtech/deepseek-r1t2-chimera:free
LLM_CHEAP_MODEL=x-ai/grok-4.1-fast:free

# Generation parameters
LLM_MAX_TOKENS=2000
LLM_TEMPERATURE=0.3
LLM_TIMEOUT_SECONDS=60
LLM_MAX_RETRIES=3
LLM_RETRY_BACKOFF_SECONDS=1.0

# Cost controls
LLM_MAX_COST_PER_REFLECTION_USD=0.0

# ============================================================================
# REFLECTION TIER CONFIGURATION
# ============================================================================

REFLECTION_DEFAULT_TIER=auto
REFLECTION_MIN_CHEAP_CONFIDENCE=0.6
REFLECTION_MIN_PRECONDITIONS=1
REFLECTION_MAX_COST_PER_DAY_USD=50.0
REFLECTION_MAX_PREMIUM_PERCENTAGE=0.15
REFLECTION_ENABLE_QUALITY_FALLBACK=true
REFLECTION_ENABLE_COST_TRACKING=true

# Error classes that force premium tier
# REFLECTION_PREMIUM_ERROR_CLASSES=data_loss,security_breach,production_outage,corruption

# ============================================================================
# CLUSTERING / CACHED TIER (EXPERIMENTAL)
# ============================================================================

# Enable cached-tier by matching incoming episodes against stored cluster templates.
# Requires templates persisted in KyroDB under namespace: {customer_id}:cluster_templates
CLUSTERING_ENABLED=false
CLUSTERING_TEMPLATE_MATCH_MIN_SIMILARITY=0.85
CLUSTERING_TEMPLATE_MATCH_K=5

# Offline clustering parameters (used by clustering/template generation jobs)
CLUSTERING_MIN_CLUSTER_SIZE=5
CLUSTERING_MIN_SAMPLES=3
CLUSTERING_METRIC=cosine
CLUSTERING_CLUSTER_CACHE_TTL_SECONDS=3600

# ============================================================================
# SEARCH CONFIGURATION
# ============================================================================

SEARCH_DEFAULT_K=20
SEARCH_MAX_K=100
SEARCH_PRECONDITION_THRESHOLD=0.5
SEARCH_SIMILARITY_THRESHOLD=0.6
SEARCH_FETCH_MULTIPLIER=5

# LLM semantic validation (disabled by default)
SEARCH_ENABLE_LLM_VALIDATION=false
SEARCH_LLM_SIMILARITY_THRESHOLD=0.85
SEARCH_LLM_CONFIDENCE_THRESHOLD=0.7
SEARCH_LLM_TIMEOUT_SECONDS=2
SEARCH_LLM_CACHE_TTL_SECONDS=300
SEARCH_MAX_LLM_COST_PER_DAY_USD=10.0

# ============================================================================
# HEALTH CHECK CONFIGURATION
# ============================================================================

# Thresholds for degraded state detection
HEALTH_KYRODB_LATENCY_WARNING_MS=100
HEALTH_KYRODB_LATENCY_ERROR_MS=500
HEALTH_EMBEDDING_LATENCY_WARNING_MS=50
HEALTH_EMBEDDING_LATENCY_ERROR_MS=200
HEALTH_CACHE_TTL_SECONDS=5

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

LOGGING_LEVEL=INFO
LOGGING_JSON_OUTPUT=true
LOGGING_COLORIZED=false
LOGGING_SLOW_REQUEST_WARNING_MS=100
LOGGING_SLOW_REQUEST_ERROR_MS=500
LOGGING_SERVICE_NAME=vritti-episodic-memory
LOGGING_SERVICE_VERSION=0.1.0
LOGGING_ENVIRONMENT=production

# ============================================================================
# CORS CONFIGURATION
# ============================================================================

# IMPORTANT: Configure allowed origins for production!
# Use comma-separated list of allowed origins
CORS_ALLOWED_ORIGINS=https://app.example.com,https://api.example.com
CORS_ALLOW_CREDENTIALS=true
CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
CORS_ALLOWED_HEADERS=Authorization,Content-Type,X-API-Key,X-Request-ID
CORS_MAX_AGE=600

# ============================================================================
# AUTHENTICATION & SECURITY
# ============================================================================

# Admin API key (REQUIRED for admin endpoints in production)
# Generate with: openssl rand -hex 32
ADMIN_API_KEY=your-32-character-minimum-admin-key-here

# API key cache settings
AUTH_API_KEY_CACHE_TTL_SECONDS=300
AUTH_API_KEY_CACHE_MAX_SIZE=10000


# ============================================================================
# HYGIENE POLICIES
# ============================================================================

HYGIENE_DECAY_CHECK_INTERVAL_HOURS=168  # Weekly
HYGIENE_ARCHIVE_AGE_DAYS=180            # 6 months
HYGIENE_DELETE_UNUSED_AGE_DAYS=90       # 3 months
HYGIENE_MIN_RETRIEVAL_COUNT_TO_KEEP=1
HYGIENE_ENABLE_PROMOTION=true
HYGIENE_PROMOTION_INTERVAL_HOURS=720    # Monthly
HYGIENE_CLUSTER_MIN_SAMPLES=3
HYGIENE_CLUSTER_EPS=0.3

# ============================================================================
# STORAGE PATHS
# ============================================================================

# Customer database (SQLite)
STORAGE_CUSTOMER_DB_PATH=./data/customers.db

SERVICE_ARCHIVE_STORAGE_PATH=/data/archive
